<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8">
<title>QUIZZ</title>
<style>
@font-face {
	font-family: myfont;
	font-style: normal;
	font-weight: 400;
	src: url(josefinslab.ttf);
}

html, body {
    height: 100%;
    width: 100%;
    padding: 0;
    margin: 0;
transition: opacity 0.1s;
}

iframe	{
	display:none;
}

.noselect {
	-webkit-touch-callout: none; /* iOS Safari */
	-webkit-user-select: none; /* Safari */
	-khtml-user-select: none; /* Konqueror HTML */
	-moz-user-select: none; /* Old versions of Firefox */
	-ms-user-select: none; /* Internet Explorer/Edge */
	user-select: none; /* Non-prefixed version */
}

.page {
	display:none;
	position:fixed;
	left:0px;
	top:0px;
	width:100%;
	height:100%;
	flex-direction:column;
	justify-content:space-between;
}

.header {
	left: 0px;
	width: 100%;
	height: 12vh;
	border-collapse: collapse;
	background-color: #AAA;
	color: white;
	display:flex;
	justify-content:center;
	align-items:center;
}

.header span {
	text-align: center;
	font-family: myfont;
	font-size: 6vw;
	letter-spacing: 2px;
}

#welcome .content {			
	display:flex;
	flex-direction:row;
	flex:auto;
}

#welcome .content .left {
	width:50%;
	overflow:hidden;
}

#welcome .content .right {
	width:50%;
}

.footer {
	width: 100%;
	height: 12vh;
	background-color: #AAA;
	display:flex;
	justify-content:center;
	align-items:center;
}

.footer button {
	font-size: 5vh;
	font-family: myfont;
	border-radius: 10px;
	padding-left: 15vw;
	padding-right: 15vw;
	background-color: inherit;
	color: white;
	border:2px solid white;
	cursor:pointer;
	padding-top:2vh;
	padding-bottom:1vh;
}

.footer button:hover {
	background-color:white;
	color:#AAA;
}

.footer label {
	font-size:6vh;
	font-family:myfont;
	color:white;
	cursor:pointer;
}

#question {
	background-color: black;
	height:80vh;
	width:100%;
	display: flex;
	align-items: center;
	justify-content: center;
}

#question img {
	transition: height 0.5s;
	height:100%;
}

#choices {
	height: 20vh;
	width: 100%;
	display:flex;
	flex-direction:row;
}

#choices .half  {
	display:flex;
	flex-direction:column;
	width:50%;
	height:20vh;
}

#choices .half div  {
	height: 10vh;
	text-align: center;
	font-family: myfont;
	font-size: 36px;
	color: #333;
	overflow:hidden;
	display:flex;
	align-items:center;
	justify-content:center;
}

#choices .half div.wrong {
	background-color:white;
}

#choices .half div span {
	font-size:4vw;
	font-weight:bold;
	transition: font-size 0.5s;
	overflow:hidden;
}

#choices .half div.wrong span {
	color:white;
}

#choices .half div.zero span {
	font-size:1px;
}

#r1 {
	background-color: #FF8;
}

#r2 {
	background-color: #88F;
}

#r3 {
	background-color: #8F8;
}

#r4 {
	background-color: #F88;
}

#chrono {
	position: fixed;
	top: 10px;
	right: 10px;
	width: 80px;
	height: 80px;
	z-index: 10;
}

#number {
	position:fixed;
	top:10px;
	left:0px;	
	width:80px;
	z-index:10;
	font-size: 5vw;
	font-family: myfont;
	font-weight:bold;
	text-align:center;
	color:white;
	background-color:black;
}

#welcome .content .left .users {
	width:100%;
	text-align:center;
}

.users span {
	font-size: 4vw;
	font-family: myfont;
	text-align: center;
	height:7vh;
	width:100%;
	white-space:nowrap;
	text-overflow:clip;
	overflow:hidden;
}

#score {
	display:flex;
	flex-direction:column;
	align-items:start;
}

#score .content {	
	display:flex;
	flex-direction:row;
	height:100%;
}

#score .content .left {
	width:10vw;
}

#score .content .right {
	width:10vw;
}

#score .content .center {
	width:80vw;
	display:flex;
	flex-direction:column;
	justify-items:start;
}

#score .content .center table {
	font-size:6vh;
	font-family: myfont;
	text-align: center;
	height:9vh;
	width:600px;
}

#score .content .center table tr td {
	overflow:hidden;
	text-wrap-mode:nowrap;
	text-overflow:clip;
}

#welcome button:disabled {
	color: #BBB;
}

.qrcode {
	position: fixed;
	top: 12vh;
	width: 50%;
	left: 50%;
	bottom:12vh;
	table-layout:fixed;
	white-space:nowrap;			
}

.qrcode .area {
	position: absolute;
}

</style>
</head>

<body>


	<div class="page" id="welcome">
		<div class="header">
			<span></span>
		</div>
		<div class="content">
			<div class="left">
				<div class="users" border="0" width="100%">
				</div>
			</div>
			<div class="right">
				<div class="qrcode">
					<div class="area"></div>
				</div>
			</div>
		</div>
		<div class="footer">
			<button>OK</button>
		</div>
	</div>


	<div class="page" id="pageq">
		<div id="chrono">
			<canvas width="80" height"80" />
		</div>
		<div id="number">
		</div>
		<div id="question">
			<img id="image" src="" />
		</div>
		<div id="choices">
			<div class="half">
			<div id="r1"><span></span></div>
			<div id="r2"><span></span></div>
			</div>
			<div class="half">
			<div id="r3"><span></span></div>
			<div id="r4"><span></span></div>
			</div>
		</div>
	</div>

	<div class="page" id="score">	
		<div class="header">
			<span>SCORE</span>
		</div>
		<div class="content">
			<div class="left"> </div>
			<div class="center">
				<table> </table>
			</div>
			<div class="right"></div>
		</div>
	</div>

</body>
<script src="fullscreen.js"></script>
<script src="qrcode.js"></script>
<script src="i18n.js"></script>
<script>
	var started = false;
	var seq = 0;

	var COLORS = ["#FF8","#88F","#8F8","#F88"];

	// chart canvas
	var chart = document.createElement("canvas");
	var w = chart.width = 600;
	var h = chart.height = 600;

	// each question proposed during 20 seconds
	var delay = get_delay() || 25;
	var gname = get_param("game") || "test";
	var ratio = get_param("ratio") || "1";

	var url = location.protocol+"//"+location.host;
	document.querySelector("#welcome .header span").innerText = url;

	var chrono = document.querySelector("#chrono canvas");

	var WebSocket = window.WebSocket || window.MozWebSocket;
	var cn = new WebSocket("wss://" + document.location.host);

	var canreply = false;

	var gid =0;

	var t1 = null;	// start of game

	var users = [];

	var game = null;
	var images = [];		// preloaded images
	var questions = null;
	var qindex = -1;

	var showrep = get_param("rep")!="no";

	load_game(gname);

	document.querySelector("#question img").style.transform = 
		`scale(${ratio},1)`;
		
	document.querySelector("#welcome .header").
		addEventListener("dblclick",ondblclick);
	document.querySelector("#welcome .footer button").
		addEventListener("click",start_game);

	setInterval(show_qrcode,1000);

	cn.onopen = function () {
		send({ type: "desktop", seq});
	}

	cn.onerror = function (err) { }

	cn.onmessage = function (event) {

		var msg = JSON.parse(event.data);
		console.log("MESSAGE " + event.data);

		switch (msg.type) {
			case "gid":
				var banner = document.querySelector("#welcome .header span");
				show_page("welcome");
				break;
				
			case "mobile":
				var prompt = i18n(I_TEAM);
				seq++;
				send({ type: "welcome", pid: msg.pid, prompt: prompt, seq });
				break;

			case "user":
				// no new player when game is started
				if(started) {
					console.log("SENDING STARTED TO ",msg.pid);
					send({type:"error",pid:msg.pid,value:"started"});
					return;	
				}
				//if(qindex>=0) break;

				// look whether user already registered
				var found = -1;
				for(var i=0;i<users.length;i++) {
					if(users[i].name==msg.value)
						found = i;
				}
				
				var now = new Date().getTime();
				if(found>=0) {
					// replace
					users[found].pid=msg.pid;
					users[found].time = now;
				}
				else {
					users.push({ name:msg.value, pid:msg.pid, score:0 , detail:"",time:now });
				}

				if(qindex<0) {
					// game not started yetÂ§
					display_users("welcome","time");
					seq++;
					send({
						type: "status",
						pid: msg.pid,
						seq,
						line1: i18n(I_WELCOME, msg.value),
						line2: "",
						line3: i18n(I_WAIT, 1)
					});
				} 
				else {
					seq++;
					send({
						type:"status",
						pid:msg.pid,
						seq,
						line1:i18n(I_WELCOME,msg.value),
						line2:"",
						line3: i18n(I_WAIT,qindex+1)
					});
				}
				break;

			case "answer":
				if(!canreply) {
					seq++;
					send({ type: "retry", pid: msg.pid, seq });
					break;
				}

				var user = get_user(msg);
				if (!user) break;
				user.rep = msg.value;
				if (msg.value == questions[qindex].answer) {
					user.score++;
					user.detail += "1";
				}
				else
					user.detail += "0";

				seq++;
				send({
					type: "status",
					pid: msg.pid,
					seq,
					line1: format_reply(msg.value),
					line2: i18n(I_THANKS),
					line3: ""
				});
				break;

			case "busy":
				alert("Un autre jeu est en cours");
				break;

			case "close":
				window.close();
				break;
		}
	}


// ***************************************************************************


	function show_question(index) {

		qindex = index;
		var question = questions[index];

		document.querySelector("#number").innerText = ""+(qindex+1);

		for (var i = 0; i < users.length; i++)
			users[i].rep = null;

		document.querySelector("#r1").classList.add("zero");
		document.querySelector("#r2").classList.add("zero");
		document.querySelector("#r3").classList.add("zero");
		document.querySelector("#r4").classList.add("zero");
	

		document.querySelector("#question img").height = 0;
		document.querySelector("#question img").src = images[index].src;
		document.querySelector("#r1 span").innerText = question.choices[0];
		document.querySelector("#r2 span").innerText = question.choices[1];
		document.querySelector("#r3 span").innerText = question.choices[2];
		document.querySelector("#r4 span").innerText = question.choices[3];


		seq++;
		send({ type: "question" , seq});

		setTimeout(f0,  500);
		setTimeout(f1, 1000);
		setTimeout(f2, 6000);
		setTimeout(f3, 6500);
		setTimeout(f4, 7000);
		setTimeout(f5, 7500);
		setTimeout(f6, 8000);

		function f0() {
			send({ type: "question" , seq});
			show_page("pageq");
		}

		function f1() {
			send({ type: "question" , seq});
			var el1 = document.querySelector("#question");
			var el2 = document.querySelector("#choices");
			var h = el2.offsetTop - el1.offsetTop;
			document.querySelector("#question img").height = h;
			}

		function f2() {
			send({ type: "question", seq });
			document.querySelector("#r1").classList.remove("zero");
		}

		function f3() {
			send({ type: "question", seq });
			document.querySelector("#r3").classList.remove("zero");
		}

		function f4() {
			send({ type: "question", seq });
			document.querySelector("#r2").classList.remove("zero");
		}

		function f5() {
			send({ type: "question", seq });
			document.querySelector("#r4").classList.remove("zero");
		}

		function f6() {
			send({ type: "question", seq });
			canreply = true;
			start_chrono();
		}
	}


// ***************************************************************************

	function finish_question() {

		canreply = false;

		var values = [0,0,0,0,0];
		for(var i=0;i<users.length;i++) 
			if(users[i].rep!=null)
				values[users[i].rep-1]++;
			else
				values[4]++;

		console.log("VALUES");
		console.log(values);

		
		if(showrep)	 {
			document.querySelector("#question img").src = draw_chart(chart,values);
			setTimeout(show_answer,4000);
			}
		else if(users.length==0)
			setTimeout(next_question,10);
		else
			setTimeout(next_question, 4000);
	}

// ***************************************************************************

	function show_answer() {	
		
		var question = questions[qindex];
		var answer =  question.answer;

		for (var i = 1; i <= 4; i++) 
			if (i != answer) 
				document.querySelector("#r" + i).classList.add("wrong");
		setTimeout(show_score, 4000);
	}


// ***************************************************************************

	function show_score() {
		
		for(var i=1;i<=4;i++) 
		document.querySelector("#r"+i).classList.remove("wrong");

		display_scores("score","score");
		show_page("score");

		document.querySelector("#r1").classList.add("zero");
		document.querySelector("#r2").classList.add("zero");
		document.querySelector("#r3").classList.add("zero");
		document.querySelector("#r4").classList.add("zero");

		seq++;	
		for (var i = 0; i < users.length; i++) {
			var user = users[i];
			if(!user.rep)
				user.detail += "-";
			var msg = {
				type: "status",
				pid: user.pid,
				seq,
				line1: format_reply(user.rep),
				line2: i18n(I_USCORE, user.score + " / " + (qindex+1)),
				line3: (qindex + 1 >= questions.length) ? "" : i18n(I_WAIT, qindex + 2)
			};
			send(msg);
		}

		if(users.length==0)
			setTimeout(next_question,10);
		else
			setTimeout(next_question, 4000);

	}


// ***************************************************************************

	function format_reply(rep) {
		if (rep == null)
			return i18n(I_NANSWER);
		else
			return i18n(I_ANSWER, "<span class='c" + rep + "'>â </span>");
	}


// ***************************************************************************

	function next_question() {
		if (qindex + 1 >= questions.length)   {
			console.log("NO MORE QUESTION - CLOSE DESKTOP CONNECTION");
			cn.close();
			return;
			}
		else
			show_question(qindex + 1);
	}


// ***************************************************************************

	function show_page(name) {
		document.body.style.opacity = 0;
		
		setTimeout(f1,100);
		setTimeout(f2,200);

		function  f1() {
			var pages = document.querySelectorAll(".page");
			for (var i = 0; i < pages.length; i++)
				pages[i].style.display = "none";
			var page = document.querySelector(".page#" + name);
			if (page) page.style.display = "flex";
		}

		function f2() {
			document.body.style.opacity = 1;
		}	
		
	}


// ***************************************************************************

	function start_chrono() {	
		t1 = new Date().getTime();
		document.querySelector("#chrono").style.display = "block";
		setTimeout(draw_chrono, 0);
	}


// ***************************************************************************

	function draw_chrono() {
		
		var t2 = new Date().getTime();
		var pct = (t2 - t1) / (1000 * delay);

		if (pct > 1) {
			document.querySelector("#chrono").style.display = "none";
			finish_question();
			return;
		}

		var size = 80;
		var ctx = chrono.getContext("2d");
		var x = size / 2;
		var y = size / 2;
		var r = size / 2;
		var a = Math.PI * 2 * pct;
		ctx.clearRect(0, 0, size, size);
		ctx.beginPath();
		ctx.moveTo(x, y);
		ctx.arc(x, y, r, a - Math.PI / 2, Math.PI * 2 - Math.PI / 2, false);
		ctx.closePath();
		ctx.fillStyle = "#888";
		ctx.fill();

		setTimeout(draw_chrono, 100);
	}


// ***************************************************************************

	function get_user(msg) {
		for (var i = 0; i < users.length; i++)
			if (users[i].pid == msg.pid)
				return users[i];
		return null;
	}

// ***************************************************************************

	function display_users(page,key) {


		var w = (window.innerWidth*48/100)|0;
		var h = (window.innerHeight*10/100)|0;

		var table = document.querySelector("#" + page + " .users");
		var s = ""
		for (var i = 0; i < users.length; i++) {

			var name = users[i].name;
			if(name.length>30) name = name.substring(0,30);

			s += "<span>";
			s += name + "<br>"
			s += "</span>"
		}

		table.innerHTML = s;

	}

// ***************************************************************************


	function display_scores(page,key) {

	var hdr = document.querySelector("#score .header span");
	if(qindex+1==questions.length) 
		hdr.innerText = "SCORE  FINAL";

	// sort users by decreasing key value
		users.sort( function(ua,ub) { return ub[key]-ua[key] });

		var w = (window.innerWidth*48/100)|0;
		var h = (window.innerHeight*10/100)|0;

		var table = document.querySelector("#score .content .center table ");
		var s = ""
		for (var i = 0; i < users.length; i++) {
			var user = users[i].name;
			if(user.length>30) user = user.substring(0,30);

			var post = users[i].score == questions.length ? "ð":"";

			var total =  users[i].score;

			s += "<tr>";
			s += "<td width='55%'>" + user + " &nbsp; "+post+"&nbsp;</td>";
			s += "<td width='10%'>"+total+"</td>";
			s += "</tr>"
		}
		table.innerHTML = s;


	}

// ***************************************************************************


function send(msg){
	cn.send(JSON.stringify(msg));
}

// ***************************************************************************

function show_qrcode() {

	var qdiv = document.querySelector(".qrcode");

	var rect = qdiv.getBoundingClientRect();

	var width = rect.width|0;
	var height = rect.height|0;
	if(height>width)
		height=width;
	else if(width>height)
		width=height;

	width -= 50;
	height -= 50;

	var area = document.querySelector(".qrcode .area");
	area.innerHTML = "";

	area.style.top = ((rect.height/2 - height/2)|0)+"px";
	area.style.left = ((rect.width/2 - width/2)|0)+"px";
	area.style.width = width+"px";
	area.style.height = height+"px";

	var url = location.protocol+"//"+location.host;

	var qrcode = new QRCode(area, {
		text:url,
		width:width,
		height:height,
		colorDark: "#000000",
		colorLight:"#FFFFFF",
		correctLevel: QRCode.CorrectLevel.H
	});
}

// ***************************************************************************

function load_game(gname) {

	var iframe = document.createElement("iframe");
	document.body.appendChild(iframe);

	iframe.addEventListener("load", onload);
	iframe.addEventListener("error",onerror);
	iframe.src = gname+".json";

	function onload(e) {
		var t = iframe.contentWindow.document.body.innerText;
		try {
			parse_game(t);
			}
		catch(err) {
			alert("Erreur dans le format du jeu");
			console.log(err);
			}
	}

	function onerror(err) {
		alert("Erreur au chargement du jeu");
		console.log(err);
	}
}

function parse_game(t) {

	game = JSON.parse(t);

	questions = game.questions;

	var nimg = 0;
	var nerr = 0;
        
	for (var i = 0; i < questions.length; i++) {
			var image = new Image();
			image.addEventListener("load", onload);
			image.addEventListener("error", onerror);
			image.src = game.name+"/"+questions[i].img;
			images.push(image);
	}

	function onload() {
			nimg ++;
	}

	function onerror() {
		if(nerr>0) return;
		nerr++;
		alert("Erreur au chargement des images");
	}
}

// ***************************************************************************

function start_game() {


	started = true;

	show_page("pageq");

	show_question(0);

}

// ***************************************************************************

function get_delay() {

	var s = get_param("delay");
	if(!s) return null;

	return parseInt(s);
}

// ***************************************************************************

function get_param(name) {

	var s = location.search.substring(1).split("&");
	for(var i=0;i<s.length;i++) {
		var p = s[i].split("=");
		if(p.length==2)
			if(p[0]==name)
				return p[1];
	}

	return null;
}


// ***************************************************************************

function draw_chart(chart,values) {

	const COLORS = ["#FF8","#88F","#8F8","#F88","#DDD"];

	var ctx = chart.getContext("2d");
	
	var w = chart.width;
	var h = chart.height;

	var xc = w/2;
	var yc = h/2;

	ctx.fillStyle = "black";
	ctx.fillRect(0,0,w,h);
	
	var r = w*2/6;
	if(h*2/3<r) r = h*2/3;

	r = r||0;	

	/*
	var slices = [];
	for(var i=0;i<values[0];i++) slices.push(COLORS[0]);
	for(var i=0;i<values[1];i++) slices.push(COLORS[1]);
	for(var i=0;i<values[2];i++) slices.push(COLORS[2]);
	for(var i=0;i<values[3];i++) slices.push(COLORS[3]);
	for(var i=0;i<values[4];i++) slices.push(COLORS[4]);
	*/

	var sum = values[0]+values[1]+values[2]+values[3]+values[4];

	var start = -Math.PI/2;
	var end = 0;
		
	for(var i=0;i<5;i++) {
		end = start - 2*Math.PI*values[i]/sum;
		draw_slice(start,end,COLORS[i]);
		start = end;
	}

	start = -Math.PI/2;
	ctx.lineWidth = 3;
	ctx.strokeStyle = "black";

	for(var i=0;i<sum;i++) {
		ctx.beginPath();
		ctx.moveTo(xc,yc);
		ctx.lineTo(xc+r*Math.cos(start),yc+r*Math.sin(start));
		ctx.stroke();
		start += 2*Math.PI/sum;
	}

	ctx.fillStyle = "black";
	ctx.beginPath();
	ctx.arc(xc,yc,r/2,0,2*Math.PI,1);
	ctx.fill();

	return chart.toDataURL();

	function draw_slice(start,end,color) {
		ctx.fillStyle = color;
		ctx.strokeStyle = "black";
		ctx.beginPath();
		ctx.moveTo(xc,yc);
		ctx.lineTo(xc+r*Math.cos(start),yc+r*Math.sin(start));
		ctx.arc(xc,yc,r,start,end,1);
		ctx.closePath();
		ctx.fill();
	}

}


// ***************************************************************************

function ondblclick(event) {

    var target = event.target;

    try {
        if (screenfull.isEnabled) { screenfull.toggle(); }
    } catch(err) {
        
    }

}


// ***************************************************************************


</script>
</html>
