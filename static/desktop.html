<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<style>
		@font-face {
			font-family: myfont;
			font-style: normal;
			font-weight: 400;
			src: url(https://fonts.gstatic.com/s/josefinslab/v10/lW-5wjwOK3Ps5GSJlNNkMalnqg6q.ttf);
		}

		body {
			margin: 0px;
			transition: opacity 0.1s;
		}

		.page {
			width: 100%;
		}

		#question {
			position: fixed;
			top: 0px;
			left: 0px;
			height: 80%;
			width: 100%;
			background-color: black;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		#question img {
			transition: height 0.5s;
		}

		#choices {
			position: fixed;
			top: 80%;
			left: 0px;
			height: 20%;
			width: 100%;
		}

		#choices .rect {
			position: fixed;
			width: 50%;
			height: 10%;
			text-align: center;
			font-family: myfont;
			font-size: 36px;
			color: #333;
			line-height: 78px;
		}

		#choices .rect span {
			font-size:5vw;
			position:absolute;
			left:50%;
			top:50%;
			transform: translate(-50%,-50%);
			transition: font-size 0.5s;
		}

		#choices .rect.zero span {
			font-size:1px;
		}

		#r1 {
			top: 80%;
			left: 0px;
			background-color: #FF8;
		}

		#r2 {
			top: 90%;
			left: 0px;
			background-color: #88F;
		}

		#r3 {
			top: 80%;
			left: 50%;
			background-color: #8F8;
		}

		#r4 {
			top: 90%;
			left: 50%;
			background-color: #F88;
		}

		#chrono {
			position: fixed;
			top: 10px;
			right: 10px;
			width: 80px;
			height: 80px;
			z-index: 10;
		}


		.users {
			position: fixed;
			top: 80px;
			width: 100%;
			left: 0px;
		}

		.users thead {
			display: block;
		}

		.users tbody {
			display: block;
			overflow-y: auto;
		}

		.users tr td {
			font-size: 5vw;
			font-family: myfont;
			text-align: left;
			padding: 20px;
		}

		.games {
			position:fixed;
			top:80px;
			width:100%;
			left:0px;
		}

		.games tr td {
			font-size: 48px;
			font-family: myfont;
			text-align: center;
			padding:20px;
			cursor:pointer;
		}

		.games tr td:hover {
			background-color:#DDD;
		}

		.header {
			position: fixed;
			top: 0px;
			left: 0px;
			width: 100%;
			height: 80px;
			border-collapse: collapse;
			background-color: #AAA;
			color: white;
		}

		.header tr td {
			text-align: center;
			font-family: myfont;
			font-size: 5vw;
			letter-spacing: 2px;
			padding-top: 10px;
			padding-bottom: 10px;
		}

		.footer {
			position: fixed;
			bottom: 0px;
			left: 0px;
			width: 100%;
			height: 80px;
			border-collapse: collapse;
			background-color: #AAA;
		}

		.footer tr td {
			text-align: center;
			font-family: myfont;
			font-size: 36px;
			padding-top: 10px;
			padding-bottom: 10px;
		}

		.footer button {
			font-size: 5vw;
			font-family: inherit;
			border-radius: 10px;
			padding-left: 25vw;
			padding-right: 25vw;
			background-color: inherit;
			color: white;
			padding-top:8px;
			padding-bottom:8px;
		}

		.mask {
			position: absolute;
			left: 0px;
			top: 0px;
			width: 100%;
			height: 100%;
			background-color: #FFFC;
		}

		.page {
			display: none;
		}

		#welcome button:disabled {
			color: #BBB;
		}
	</style>
</head>

<body>

	<div class="page" id="welcome">
		<table class="header" width="100%" border="0">
			<tr>
				<td></td>
			</tr>
		</table>
		<table class="users" width="100%" border="0">
		</table>
		<table class="footer" width="100%" border="0">
			<tr>
				<td> <button>OK</button> </td>
			</tr>
		</table>
	</div>

	<div class="page" id="games">
		<table class="header" width="100%" border="0">
			<tr><td></td></tr>
		</table>
		<table class="games" width="100%" border="0">
		</table>
	</div>
	
	<div class="page" id="pageq">
		<div id="chrono">
			<canvas width="80" height"80" />
		</div>
		<div id="question">
			<img id="image" src="" />
		</div>
		<div id="choices">
			<div id="r1" class="rect"><span></span>
				<div class="mask"></div>
			</div>
			<div id="r3" class="rect"><span></span>
				<div class="mask"></div>
			</div>
			<div id="r2" class="rect"><span></span>
				<div class="mask"></div>
			</div>
			<div id="r4" class="rect"><span></span>
				<div class="mask"></div>
			</div>
		</div>
	</div>

	<div class="page" id="score">
		<table class="header" width="100%" border="0">
			<tr>
				<td>SCORE</td>
			</tr>
		</table>
		<table class="users" width="100%" border="0">
		</table>
	</div>

</body>
<script src="i18n.js"></script>
<script src="games.js"></script>
<script>
	var delay = 10; // each question is proposed during 10 seconds

	var canvas = document.querySelector("#chrono canvas");

	var WebSocket = window.WebSocket || window.MozWebSocket;
	var cn = new WebSocket("ws://" + document.location.host);

	var questions = null;
	var qindex = -1;
	var canreply = false;

	var t1 = null;	// start of game

	var users = [];

	var images = [];		// preloaded images



	document.querySelector("#welcome .header tr td").innerText = location.href;

	document.querySelector("#welcome button").addEventListener("click",
		show_games);

	document.querySelector("#games table.games").addEventListener("click",
		select_game);


	show_page("welcome");


	cn.onopen = function () {
		send({ type: "desktop"});
	}

	cn.onerror = function (err) { }

	cn.onmessage = function (event) {

		var msg = JSON.parse(event.data);
		console.log("MESSAGE " + event.data);
		switch (msg.type) {
			case "mobile":
				if(qindex>=0) break;
				var prompt = i18n(I_TEAM);
				send({ type: "welcome", id: msg.id, prompt: prompt });
				break;

			case "user":
				if(qindex>=0) break;
				users.push({ name: msg.value, id: msg.id, score: 0 });
				display_users("welcome");
				send({
					type: "status",
					id: msg.id,
					line1: i18n(I_WELCOME, msg.value),
					line2: "",
					line3: i18n(I_WAIT, 1)
				});
				break;

			case "answer":
				if(!canreply) break;
				var user = get_user(msg);
				if (!user) break;
				user.rep = msg.value;
				if (msg.value == questions[qindex].answer)
					user.score++;
				send({
					type: "status",
					id: msg.id,
					line1: format_reply(msg.value),
					line2: i18n(I_THANKS),
					line3: ""
				});
				break;

			case "close":
				window.close();
				break;
		}
	}


	// ***************************************************************************

	function show_games() {
		var td = document.querySelector("#games .header tr td");
		td.innerText = i18n(I_GAMES);
	
		var table = document.querySelector("#games table.games");
		var s = "";
		for(var g in games) {
			s += "<tr><td>"+g+"</td></tr>";
		}
		table.innerHTML = s;
		show_page("games");


	}

	// ***************************************************************************
	function select_game(event) {
		var target = event.target;
		if(target.tagName!="TD") return;
		game = target.innerText;	
		questions = games[game];
		start_game();
	}

	// ***************************************************************************

	function start_game() {

		qindex = -1;

		for(var i=0;i<users.length;i++)
			users[i].score = 0;

		// shuffle questions
		for (var k = 0; k < questions.length; k++) {
			var k1 = (Math.random() * questions.length) | 0;
			var k2 = (Math.random() * questions.length) | 0;
			var temp = questions[k1];
			questions[k1] = questions[k2];
			questions[k2] = temp;
		}

		for (var k = 0; k < questions.length; k++)
			shuffle_choices(questions[k]);


		var nimg = 0;

		document.querySelector("#welcome button").disabled = true;


		// preload images
		for (var i = 0; i < questions.length; i++) {
			var image = new Image();
			image.addEventListener("load", onload);
			image.src = game + "/" + questions[i].img;
			images.push(image);
		}


		function onload() {
			nimg++;
			if (nimg == questions.length)
				show_question(0);		
		}

	}

	function failure(err) {
		alert("ERROR LOADING " + game);
	}


	// ***************************************************************************

	function shuffle_choices(question) {

		for (var k = 0; k < 3; k++) {
			var k1 = (Math.random() * 4) | 0;
			var k2 = (Math.random() * 4) | 0;
			var temp = question.choices[k1];
			question.choices[k1] = question.choices[k2];
			question.choices[k2] = temp;
			if (question.answer == k1 + 1) question.answer = k2 + 1;
			else if (question.answer == k2 + 1) question.answer = k1 + 1;
		}

	}

	// ***************************************************************************

	function show_question(index) {

		qindex = index;
		var question = questions[index];

		for (var i = 0; i < users.length; i++)
			users[i].rep = null;

		document.querySelector("#question img").height = 0;
		document.querySelector("#question img").src = game + "/" + question.img;
		document.querySelector("#r1 span").innerText = question.choices[0];
		document.querySelector("#r2 span").innerText = question.choices[1];
		document.querySelector("#r3 span").innerText = question.choices[2];
		document.querySelector("#r4 span").innerText = question.choices[3];

		for (var i = 1; i <= 4; i++)
			document.querySelector("#r" + i + " .mask").style.display = "none";

		document.querySelector("#r1").classList.add("zero");
		document.querySelector("#r2").classList.add("zero");
		document.querySelector("#r3").classList.add("zero");
		document.querySelector("#r4").classList.add("zero");
	
		show_page("pageq");

		send({ type: "question" });

		setTimeout(f1,  500);
		setTimeout(f2, 1000);
		setTimeout(f3, 1500);
		setTimeout(f4, 2000);
		setTimeout(f5, 2500);
		setTimeout(f6, 3000);

		function f1() {
			var el1 = document.querySelector("#question");
			var el2 = document.querySelector("#choices");
			var h = el2.offsetTop - el1.offsetTop;
			document.querySelector("#question img").height = h;
			setTimeout(f2,500);
			}

		function f2() {
			document.querySelector("#r1").classList.remove("zero");
		}

		function f3() {
			document.querySelector("#r2").classList.remove("zero");
		}

		function f4() {
			document.querySelector("#r3").classList.remove("zero");
		}

		function f5() {
			document.querySelector("#r4").classList.remove("zero");
		}

		function f6() {
			canreply = true;
			start_chrono();
		}
	}


	// ***************************************************************************

	function finish_question() {
		canreply = false;

		for (var i = 1; i <= 4; i++)
			if (i != questions[qindex].answer)
				document.querySelector("#r" + i + " .mask").style.display = "block";

		setTimeout(show_score, 4000);
	}


	// ***************************************************************************

	function show_score() {

		display_users("score");
		show_page("score");

		for (var i = 0; i < users.length; i++) {
			var user = users[i];
			var msg = {
				type: "status",
				id: user.id,
				line1: format_reply(user.rep),
				line2: i18n(I_USCORE, user.score + " / " + questions.length),
				line3: (qindex + 1 >= questions.length) ? "" : i18n(I_WAIT, qindex + 2)
			};
			send(msg);
		}
		setTimeout(next_question, 4000);

	}


	// ***************************************************************************

	function format_reply(rep) {
		if (rep == null)
			return i18n(I_NANSWER);
		else
			return i18n(I_ANSWER, "<span class='c" + rep + "'>■</span>");
	}


	// ***************************************************************************

	function next_question() {
		if (qindex + 1 >= questions.length)  
			setTimeout(show_games,10000);
		else
			show_question(qindex + 1);
	}


	// ***************************************************************************

	function show_page(name) {
		document.body.style.opacity = 0;
		
		setTimeout(f1,100);
		setTimeout(f2,200);

		function  f1() {
			var pages = document.querySelectorAll(".page");
			for (var i = 0; i < pages.length; i++)
				pages[i].style.display = "none";
			var page = document.querySelector(".page#" + name);
			if (page) page.style.display = "block";
		}

		function f2() {
			document.body.style.opacity = 1;
		}	
		
	}


	// ***************************************************************************

	function start_chrono() {	
		t1 = new Date().getTime();
		document.querySelector("#chrono").style.display = "block";
		setTimeout(draw_chrono, 0);
	}


	// ***************************************************************************

	function draw_chrono() {
		
		var t2 = new Date().getTime();
		var pct = (t2 - t1) / (1000 * delay);

		if (pct > 1) {
			document.querySelector("#chrono").style.display = "none";
			finish_question();
			return;
		}

		var size = 80;
		var ctx = canvas.getContext("2d");
		var x = size / 2;
		var y = size / 2;
		var r = size / 2;
		var a = Math.PI * 2 * pct;
		ctx.clearRect(0, 0, size, size);
		ctx.beginPath();
		ctx.moveTo(x, y);
		ctx.arc(x, y, r, a - Math.PI / 2, Math.PI * 2 - Math.PI / 2, false);
		ctx.closePath();
		ctx.fillStyle = "#888";
		ctx.fill();

		setTimeout(draw_chrono, 100);
	}


	// ***************************************************************************

	function get_user(msg) {
		for (var i = 0; i < users.length; i++)
			if (users[i].id == msg.id)
				return users[i];
		return null;
	}

	// ***************************************************************************

	function display_users(page) {
		var w = window.innerWidth/2;

		var tr = document.querySelectorAll("#" + page + " .users tr");
		if (tr.length > 1)
			var h = tr[1].offsetTop - tr[0].offsetTop - 5;
		else
			var h = 60;

		var table = document.querySelector("#" + page + " .users");
		var s = ""
		for (var i = 0; i < users.length; i++) {
			s += "<tr>";
			s += "<td><canvas width='" + w + "' height='" + h + "'></td>";
			s += "<td>" + users[i].name + "</td>";
			s += "</tr>"
		}
		table.innerHTML = s;

		if(!questions) return;

		var dx = w / questions.length;

		var c = document.querySelectorAll("#" + page + " .users canvas");
		for (var i = 0; i < users.length; i++) {
			var ctx = c[i].getContext("2d");
			ctx.fillStyle = "white";
			ctx.fillRect(0, 0, w, h);

			ctx.fillStyle = "#DDD";
			for (var j = 0; j < questions.length; j++) {
				var x = dx * j;
				ctx.fillRect(dx * j, 0, dx - 5, h);
			}

			ctx.fillStyle = "#0C0";
			for (var j = 0; j < users[i].score; j++) {
				var x = dx * j;
				ctx.fillRect(dx * j, 0, dx - 5, h);
			}
		}

		if (qindex == questions.length - 1)
			document.querySelector("#score .header tr td").innerText =
				i18n(I_FSCORE);
		else
			document.querySelector("#score .header tr td").innerText =
				i18n(I_SCORE);
	}

// ***************************************************************************

function send(msg){
	cn.send(JSON.stringify(msg));
}

// ***************************************************************************

</script>

</html>
